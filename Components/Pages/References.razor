@page "/References"
@rendermode InteractiveServer
@inject NavigationManager nav
<h3>Kilder</h3>
<MudTable bind-SelectedItem="@selectedReference" T="Reference" Items="references" Breakpoint="Breakpoint.Sm">
    <HeaderContent>
        <MudTh>URL</MudTh>
        <MudTh>Titel</MudTh>
        <MudTh>Forfatter</MudTh>
        <MudTh>Note</MudTh>
        <MudTh>Emne</MudTh>
    </HeaderContent>
    <RowTemplate Context="reference">
        <MudTd>@reference.Title</MudTd>
        <MudTd>
            <MudLink Href="@reference.URL">@reference.URL</MudLink>
        </MudTd>
        <MudTd>@reference.Author</MudTd>
        <MudTd>@reference.Note</MudTd>
        <MudTd>@reference.Subject</MudTd>
        <AuthorizeView>
            <MudTd>
                <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="() => DeleteReferenceAsync(reference)" Size="Size.Small">
                    Slet
                </MudButton>
            </MudTd>
        </AuthorizeView>
    </RowTemplate>
</MudTable>

<AuthorizeView>
    <MudExpansionPanel Text="Tilføj Reference" Class="navbar-expand mt-3 rounded-3">
        <MudForm @ref="form">
            <MudTextField @bind-Value="newReference.URL" Label="URL" Required="true" RequiredError="URL er påkrævet"/>
            <MudTextField @bind-Value="newReference.Title" Label="Titel"/>
            <MudTextField @bind-Value="newReference.Author" Label="Forfatter"/>
            <MudTextField @bind-Value="newReference.Note" Label="Note/vurdering"/>
            <MudTextField @bind-Value="newReference.Subject" Label="Emne"/>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddReference" Class="mt-4">Tilføj
            </MudButton>
        </MudForm>
    </MudExpansionPanel>
</AuthorizeView>


@code {
    [Inject] public IReferenceService ReferenceService { get; set; }
    private List<Reference> references = new();
    private Reference newReference = new();
    private MudForm form;
    private int selectedId;
    private Reference selectedReference;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            references = await ReferenceService.GetAllReferencesAsync();
        }
        catch (NullReferenceException e)
        {
            Console.WriteLine(e);
        }
    }

    private async Task AddReference()
    {
        await form.Validate();
        if (form.IsValid)
        {
            await ReferenceService.CreateReferenceAsync(newReference);
            references = await ReferenceService.GetAllReferencesAsync();
            newReference = new Reference();
            await form.ResetAsync();
            nav.Refresh(true);
        }
    }

    private async Task DeleteReferenceAsync(Reference reference)
    {
        await ReferenceService.DeleteReferenceAsync(reference);
        references = await ReferenceService.GetAllReferencesAsync();
        nav.Refresh(true);
    }

}