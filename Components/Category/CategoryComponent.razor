@using Microsoft.IdentityModel.Tokens
@rendermode InteractiveServer
@inject ICategoryService CategoryService
@inject IBlobStorageService BlobService
@inject NavigationManager Nav
<MudPaper Class="category-card">
    <MudCard Elevation="3" Class="rounded-4 category-card__inner">
        <MudCardMedia Image="@SelectedCategory.CoverImgPath" Height="140"></MudCardMedia>
        <MudCardContent>
            <MudText Style="@HeaderStyle" Typo="Typo.h5" Class="category-card__title">
                @SelectedCategory.Title
                <MudImage Src="@SelectedCategory.LogoImgPath" Height="18" Width="18"></MudImage>
            </MudText>
            @if (!SelectedCategory.Description.IsNullOrEmpty())
            {
                @if (SelectedCategory.Description.Length >= 100)
                {
                    <MudButton Size="Size.Small" OnClick="@OnExpandCollapseClick">
                        @(isExpanded ? "Fold beskrivelse" : "Udvid beskrivelse")
                    </MudButton>
                    <MudDivider/>
                    <MudCollapse Expanded="isExpanded">
                        <MudText Typo="Typo.body2">@SelectedCategory.Description</MudText>
                    </MudCollapse>
                }
                else
                {
                    <MudText Typo="Typo.body2">
                        @(SelectedCategory.Description.IsNullOrEmpty() ? "" : SelectedCategory.Description)
                    </MudText>
                }
            }
            else
            {
                <MudText Typo="Typo.body2">Ingen kategorier fundet denne gang</MudText>
            }
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.FileOpen">
                <a href="@(SelectedCategory.ParentCategoryId > 0
                             ? $"/category/{SelectedCategory.Id}"
                             : $"/topcategory/{SelectedCategory.Id}")">Ã…bn kategori
                </a>
            </MudButton>

            <AuthorizeView>
                <MudButton Size="Size.Small" OnClick="@DeleteCategoryAsync" StartIcon="@Icons.Material.Filled.Delete">Slet
                    kategori
                </MudButton>

                <MudButton Size="Size.Small" StartIcon="@Icons.Material.Filled.Edit" OnClick="@EditCategoryAsync">Rediger
                    kategori
                </MudButton>
            </AuthorizeView>

        </MudCardActions>
    </MudCard>
</MudPaper>

<style>
    .category-card {
        max-width: 360px;
    }
    .category-card__inner {
        width: 100%;
    }
    .category-card__title {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
    }
</style>

@code
{
    [Parameter] public Category SelectedCategory { get; set; }
    private bool isExpanded;

    private async Task DeleteCategoryAsync()
    {
        var blobName = Path.GetFileName(SelectedCategory.CoverImgPath);
        if (!blobName.IsNullOrEmpty())
        {
            await BlobService.DeleteBlobAsync(blobName);
            await CategoryService.DeleteCategoryAsync(SelectedCategory);
        }

        Nav.Refresh(true);
    }

    private string HeaderStyle
    {
        get
        {
            var typeAndColor = new Dictionary<string, string>
            {
                { "diverse.png", "#3D6B0C" },
                { "log.png", "#138485" },
                { "project.png", "#852F13" }
            };

            var color = typeAndColor.TryGetValue(
                Path.GetFileName(SelectedCategory?.LogoImgPath ?? string.Empty),
                out var c)
                ? c
                : "#000000";

            return $"color:{color}";
        }
    }


    private void EditCategoryAsync()
    {
        Nav.NavigateTo($"/category/edit/{SelectedCategory.Id}");
        Nav.Refresh();
    }

    private void OnExpandCollapseClick()
    {
        isExpanded = !isExpanded;
    }
}
