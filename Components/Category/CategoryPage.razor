@page "/category/{Id:int}"
@using System.Text.RegularExpressions
@attribute [StreamRendering]
@inject ICategoryService categoryService
@inject NavigationManager navigationManager
<BreadCrumbComponent Items="breadcrumbItems"></BreadCrumbComponent>
<h3>Category</h3>
<AuthorizeView>
    <MudButton Href=@($"/category/{Id}/posts/new") StartIcon="@Icons.Material.Filled.AddToQueue">Opret nyt opslag
    </MudButton>
</AuthorizeView>
@if (Id > 0)
{
    if (posts.Count <= 0)
    {
        <MudSkeleton/>
        <MudSkeleton SkeletonType="SkeletonType.Circle" Width="50px" Height="50px"/>
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="200px" Height="110px"/>
        <MudText>Indlæser opslag...</MudText>
    }
    else
    {
        <h2>@selectedCategory.Title</h2>
        <p>Opslag i kategori: @posts?.Count</p>
        <MudTable T="Post" Items="@posts" Breakpoint="Breakpoint.Sm"
                  Hover="true" SortLabel="Sort By"
                  OnRowClick="@(args => navigationManager.NavigateTo($"/posts/{args.Item.Id}"))">
            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<Post, object>(p => p.Title)">Titel</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<Post, object>(p => p.Content)">Indhold</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<Post, object>(p => p.DateCreated)">Oprettet</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<Post, object>(p => p.DateEdited)">Redigeret
                    </MudTableSortLabel>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Class="fw-bold" DataLabel="Titel">@context.Title</MudTd>
                <MudTd DataLabel="Indhold">
                    @StripMarkdown(context.Content, 100)
                </MudTd>
                <MudTd DataLabel="Oprettet">@context.DateCreated</MudTd>
                <MudTd DataLabel="Redigeret">@context.DateEdited</MudTd>
                <MudTd>
                    <MudButton Href=@($"/posts/{context.Id}")>Åbn</MudButton>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new[] { 10, 25, 50, 100 }"/>
            </PagerContent>
        </MudTable>
    }
}
else
{
    <p>Category not found.</p>
}

@code {
    [Parameter] public int Id { get; set; }
    [CascadingParameter] public string CategoryTitle { get; set; }
    private int postId;
    private string createdDate;
    private string lastEditedDate;
    private Category selectedCategory = new();
    private List<Post>? posts = new();
    private List<BreadcrumbItem> breadcrumbItems = new();
    private readonly bool enabled = true;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            selectedCategory = await categoryService.GetCategoryByIdAsync(Id);
            breadcrumbItems = new List<BreadcrumbItem>
            {
                new("Home", "/"),
                new(selectedCategory.Title, null, true)
            };
            CategoryTitle = selectedCategory.Title;
            posts = selectedCategory?.Posts ?? new List<Post>();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            posts = new List<Post>();
        }
    }

    private string StripMarkdown(string content, int maxLength)
    {
        if (string.IsNullOrEmpty(content))
            return "";

        // Remove markdown syntax
        var stripped = Regex.Replace(content, @"^#+\s*", "", RegexOptions.Multiline); // Headers
        stripped = Regex.Replace(stripped, @"\[([^\]]+)\]\([^\)]+\)", "$1"); // Links
        stripped = Regex.Replace(stripped, @"[*_~`]", ""); // Bold, italic, strikethrough, code
        stripped = Regex.Replace(stripped, @"\n+", " "); // Line breaks to spaces

        // Trim to max length
        return stripped.Length <= maxLength ? stripped : stripped.Substring(0, maxLength) + "...";
    }

}