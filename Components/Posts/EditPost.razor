@page "/posts/{Id:int}/edit"
@rendermode InteractiveServer
@inject IPostService Service
@inject NavigationManager Nav

<BreadCrumbComponent Items="breadcrumbItems"></BreadCrumbComponent>
<MudGrid>
    <MudItem xs="12" sm="7">
        <MudPaper class="pa-4">
            <MudForm @ref="form" Model="@selectedPost" @bind-IsValid="@isValid" @bind-Errors="@errors">
                <MudTextField T="string" Label="Titel" @bind-Value="selectedPost.Title"
                              Required="true"
                              RequiredError="Opslags titel er obligatorisk!"></MudTextField>

                <MudText Typo="Typo.subtitle2">Skriv opslagets indhold</MudText>
                <MarkdownComponent @bind-MarkdownContent="@selectedPost.Content"></MarkdownComponent>
            </MudForm>
            <MudPaper Class="pa-4 mt-4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" DropShadow="false"
                           OnClick="@ValidateAndSaveAsync">Gem
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" DropShadow="false"
                           OnClick="@ResetFormAndValidationAsync" Class="mx-2">Reset
                </MudButton>
            </MudPaper>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter] public int Id { get; set; }
    private Post selectedPost = new();
    private MudForm form;
    private string[] errors = { };
    private bool isValid;
    private List<BreadcrumbItem> breadcrumbItems = new();

    protected override async Task OnInitializedAsync()
    {
        selectedPost = await Service.GetPostByIdAsync(Id);
        breadcrumbItems = new List<BreadcrumbItem>
        {
            new("Home", "/"),
            new("Kategori", $"category/{selectedPost.CategoryId}"),
            new(selectedPost.Title, $"posts/{selectedPost.Id}/"),
            new(selectedPost.Title, null, true)
        };
    }

    private async Task ResetFormAndValidationAsync()
    {
        await form.ResetAsync();
        form.ResetValidation();
    }

    private void UpdateDate()
    {
        selectedPost.DateEdited = DateTime.Now;
    }

    private async Task ValidateAndSaveAsync()
    {
        UpdateDate();
        await form.Validate();
        isValid = form.IsValid;

        if (!isValid) return;
        try
        {
            isValid = await Service.UpdatePostAsync(selectedPost);
            if (isValid)
            {
                Nav.NavigateTo($"/category/{selectedPost.CategoryId}");
            }
        }
        catch (Exception ex)
        {
            errors = [ex.Message];
        }
    }

}