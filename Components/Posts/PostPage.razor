@page "/posts/{Id:int}"
@using Microsoft.Build.Framework
@using Radzen.Blazor
@rendermode InteractiveServer
@inject IPostService Service
@inject NavigationManager nav

<BreadCrumbComponent Items="breadcrumbItems"></BreadCrumbComponent>

<MudPaper Elevation="3" Class="bg-body-secondary mt-5">
    <MudCard>
        <MudCardContent>
            <MudGrid Spacing="1" Justify="Justify.SpaceEvenly">
                <MudText Color="Color.Primary" Typo="Typo.h4" Class="text-capitalize">@selectedPost.Title</MudText>
                <MudText Class="mt-3" Style="color: seagreen;" Typo="Typo.subtitle1">Opslag oprettet:
                    @createdDate</MudText>
                <MudText Class="mt-3" Style="color: seagreen" Typo="Typo.subtitle1">Opslag sidst redigeret:
                    @lastEditedDate</MudText>
            </MudGrid>
            <MudPaper Class="border-secondary-subtle border-4 mt-5">
                <RadzenMarkdown AllowHtml="@allowHTML">
                    @selectedPost.Content
                </RadzenMarkdown>
            </MudPaper>
        </MudCardContent>
        <MudCardActions>
            <AuthorizeView>
                <MudButton OnClick="@OnDeleteClick" StartIcon="@Icons.Material.Filled.Delete">Slet
                    opslag
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Edit" OnClick="@EditPostAsync">Rediger
                    opslag
                </MudButton>
            </AuthorizeView>
        </MudCardActions>
    </MudCard>
</MudPaper>

@code {
    [Parameter] public int Id { get; set; }
    [Required] public Post selectedPost { get; set; } = new();

    private int categoryId { get; set; }
    private string? createdDate;
    private string? lastEditedDate;
    private bool? isConfirmed;
    private readonly bool allowHTML = true;
    private List<BreadcrumbItem> breadcrumbItems = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            selectedPost = await Service.GetPostByIdAsync(Id);
            categoryId = selectedPost.CategoryId;
            breadcrumbItems = new List<BreadcrumbItem>
            {
                new("Home", "/"),
                new("Kategori", $"category/{categoryId}"),
                new($"{selectedPost.Title}", null, true)
            };
            createdDate = selectedPost.DateCreated.ToString("d");
            lastEditedDate = selectedPost.DateEdited.ToString("d");
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }

    private async Task DeletePostAsync()
    {
        await Service.DeletePostAsync(selectedPost);
        nav.NavigateTo($"/category/{categoryId}");
    }

    private async Task EditPostAsync()
    {
        nav.NavigateTo($"/posts/{Id}/edit");
    }

    private async Task OnDeleteClick()
    {
        await DeletePostAsync();
    }

}