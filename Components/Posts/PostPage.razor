@page "/posts/{Id:int}"
@using Microsoft.Build.Framework
@using Radzen.Blazor
@rendermode InteractiveServer
@inject IPostService Service
@inject NavigationManager nav

<MudPaper>
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h3">@selectedPost.Title</MudText>
            <RadzenMarkdown AllowHtml="@allowHTML">
                @selectedPost.Content
            </RadzenMarkdown>
        </MudCardContent>
        <MudCardActions>
            <AuthorizeView>
                <MudButton OnClick="@OnDeleteClick" StartIcon="@Icons.Material.Filled.Delete">Slet
                    opslag
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Edit" OnClick="@EditPostAsync">Rediger
                    opslag
                </MudButton>
            </AuthorizeView>
        </MudCardActions>
    </MudCard>
</MudPaper>

@code {
    [Inject] private IDialogService DialogService { get; set; }
    [Parameter] public int Id { get; set; }
    [Required] public Post selectedPost { get; set; } = new();
    private int categoryId { get; set; }
    private bool? isConfirmed;
    private readonly bool allowHTML = true;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine(selectedPost.Content);
        try
        {
            selectedPost = await Service.GetPostByIdAsync(Id);
            categoryId = selectedPost.CategoryId;
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }

    private async Task DeletePostAsync()
    {
        await Service.DeletePostAsync(selectedPost);
        nav.NavigateTo($"/category/{categoryId}");
    }

    private async Task EditPostAsync()
    {
        nav.NavigateTo($"/posts/edit/{Id}");
    }

    private async void OnDeleteClick()
    {
        isConfirmed = await DialogService.ShowMessageBox(
            "ADVARSEL",
            "Det er permanent at slette",
            "Delete", cancelText: "Cancel");
        if (isConfirmed == true) await DeletePostAsync();
        StateHasChanged();
    }

}