@page "/posts/{Id:int}"
@using Microsoft.Build.Framework
@using Radzen.Blazor
@rendermode InteractiveServer
@inject IPostService Service
@inject NavigationManager nav

<MudPaper Elevation="3" Class="bg-body-secondary mt-5">
    <MudCard>
        <MudCardContent>
            <MudText Color="Color.Primary" Typo="Typo.h4" Class="text-capitalize">@selectedPost.Title</MudText>
            <MudGrid Spacing="8" Justify="Justify.SpaceEvenly">
            <MudText Style="color: seagreen" Typo="Typo.subtitle1">Opslag oprettet: @createdDate</MudText>
            <MudText Style="color: seagreen" Typo="Typo.subtitle1">Opslag sidst redigeret: @lastEditedDate</MudText>
            </MudGrid>
            <MudPaper  Class="border-secondary-subtle border-4 mt-5">
            <RadzenMarkdown AllowHtml="@allowHTML">
                @selectedPost.Content
            </RadzenMarkdown>
            </MudPaper>
        </MudCardContent>
        <MudCardActions>
            <AuthorizeView>
                <MudButton OnClick="@OnDeleteClick" StartIcon="@Icons.Material.Filled.Delete">Slet
                    opslag
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Edit" OnClick="@EditPostAsync">Rediger
                    opslag
                </MudButton>
            </AuthorizeView>
        </MudCardActions>
    </MudCard>
</MudPaper>

@code {
    [Inject] private IDialogService DialogService { get; set; }
    [Parameter] public int Id { get; set; }
    [Required] public Post selectedPost { get; set; } = new();
    
    private int categoryId { get; set; }
    private string? createdDate;
    private string? lastEditedDate;
    private bool? isConfirmed;
    private readonly bool allowHTML = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            selectedPost = await Service.GetPostByIdAsync(Id);
            categoryId = selectedPost.CategoryId;
            createdDate = selectedPost.DateCreated.ToString("d");
            lastEditedDate = selectedPost.DateEdited.ToString("d");

        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }

    private async Task DeletePostAsync()
    {
        await Service.DeletePostAsync(selectedPost);
        nav.NavigateTo($"/category/{categoryId}");
    }

    private async Task EditPostAsync()
    {
        nav.NavigateTo($"/posts/edit/{Id}");
    }

    private async void OnDeleteClick()
    {
        isConfirmed = await DialogService.ShowMessageBox(
            "ADVARSEL",
            "Det er permanent at slette",
            "Delete", cancelText: "Cancel");
        if (isConfirmed == true) await DeletePostAsync();
        StateHasChanged();
    }

}